{% extends 'keychain/base.html' %}
{% load static %}

{% block title %}Sistemler{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'keychain/CSS/sistem_list.css' %}">
{% endblock %}

{% block content %}
<div class="container-fluid px-4 py-5">
  <!-- Modern Başlık ve Açıklama -->
  <div class="d-flex justify-content-between align-items-center mb-5">
    <div class="position-relative">
      <div class="rounded-4 p-4 shadow-lg" style="background: linear-gradient(135deg, rgba(13,110,253,0.1) 0%, rgba(13,110,253,0.05) 100%); backdrop-filter: blur(10px); border: 1px solid rgba(13,110,253,0.2); min-width:380px;">
        <div class="d-flex align-items-center">
          <div class="bg-primary bg-gradient rounded-3 p-3 me-3 shadow-sm">
            <i class="fas fa-cogs text-white fs-3"></i>
          </div>
          <div>
            <h2 class="fw-bold text-dark mb-1 display-6">
              Sistemler
            </h2>
            <p class="text-muted mb-0" style="font-size:1.1rem; letter-spacing:0.3px;">
              Sistemde kayıtlı sistem listelerini yönetin
            </p>
          </div>
        </div>
      </div>
      <div class="position-absolute" style="top:-10px; right:-10px; width:60px; height:60px; background: linear-gradient(135deg, #0d6efd, #6610f2); opacity:0.1; border-radius:50%; filter: blur(20px);"></div>
    </div>
    <button type="button" class="btn btn-primary btn-lg shadow-sm rounded-3 px-4" data-bs-toggle="modal" data-bs-target="#sistemEkleModal">
      <i class="fas fa-plus-circle me-2"></i>Yeni Sistem
    </button>
  </div>

  <!-- Filtre Butonları -->
  <div class="mb-4">
    <div class="d-flex justify-content-between align-items-center">
      <div class="btn-group shadow-sm rounded-3" role="group" aria-label="Sistem tipi filtreleri">
        <button type="button" class="btn btn-light active px-4 py-2" data-filter="all">
          <i class="fas fa-th-large me-2"></i>Tümü
        </button>
        <button type="button" class="btn btn-primary px-4 py-2" data-filter="Database" style="background-color: #0d6efd; border-color: #0d6efd;">
          <i class="fas fa-database me-2"></i>Database
        </button>
        <button type="button" class="btn btn-success px-4 py-2" data-filter="VPN" style="background-color: #198754; border-color: #198754;">
          <i class="fas fa-shield-alt me-2"></i>VPN
        </button>
        <button type="button" class="btn btn-warning px-4 py-2" data-filter="SERVER" style="background-color: #ffc107; border-color: #ffc107; color: #000;">
          <i class="fas fa-server me-2"></i>Server
        </button>
        <button type="button" class="btn btn-info px-4 py-2" data-filter="Application" style="background-color: #0dcaf0; border-color: #0dcaf0; color: #000;">
          <i class="fas fa-desktop me-2"></i>Application
        </button>
      </div>
      <div class="d-flex justify-content-end">
        <div class="dropdown" role="group" aria-label="Projeler">
          <button type="button" class="btn btn-light px-4 py-2 dropdown-toggle" data-bs-toggle="dropdown" aria-expanded="false">
            <i class="fas fa-folder me-2"></i>Projeler
          </button>
          <ul class="dropdown-menu">
            <li>
              <a class="dropdown-item" href="#" onclick="filterByProject('all')">
                <i class="fas fa-th-large me-2"></i>Tüm Projeler
              </a>
            </li>
            <li><hr class="dropdown-divider"></li>
            {% for project in projects %}
            <li>
              <a class="dropdown-item" href="#" onclick="filterByProject('{{ project.name }}')" data-project-name="{{ project.name }}">
                <i class="fas fa-folder-open me-2"></i>{{ project.name }}
              </a>
            </li>
            {% endfor %}
            <li><hr class="dropdown-divider"></li>
            <li>
              <a class="dropdown-item" href="{% url 'keychain:project_list' %}?modal=projeEkleModal">
                <i class="fas fa-plus me-2"></i>Yeni Proje
              </a>
            </li>
          </ul>
        </div>
      </div>
      <div class="search-container position-relative" style="width: 350px;">
        <div class="input-group shadow-sm rounded-4 overflow-hidden" style="background: rgba(255, 255, 255, 0.9); backdrop-filter: blur(10px); border: 1px solid rgba(0,0,0,0.1);">
          <span class="input-group-text bg-transparent border-0">
            <i class="fas fa-search text-primary"></i>
          </span>
          <input type="text" 
                 class="form-control border-0 ps-0" 
                 id="systemSearch" 
                 placeholder="Sistem ara..." 
                 onkeyup="filterSystems()"
                 style="background: transparent; font-size: 0.95rem; padding: 0.8rem 1rem;">
          <span class="input-group-text bg-transparent border-0 pe-3">
            <i class="fas fa-times-circle text-muted search-clear" 
               style="cursor: pointer; display: none;"
               onclick="clearSearch()"></i>
          </span>
        </div>
        <div class="search-focus-effect"></div>
      </div>
    </div>
  </div>

  <!-- Sistemler Kartları -->
  <div class="row g-4">
    {% for system in systems %}
    <div class="col-xl-3 col-lg-4 col-md-6 col-sm-12">
      <div class="card h-100 shadow-sm border-0 rounded-4 system-card" 
           data-system-id="{{ system.id }}" 
           data-project-id="{% if system.project %}{{ system.project.id }}{% else %}none{% endif %}"
           data-project-name="{% if system.project %}{{ system.project.name }}{% else %}none{% endif %}"
           style="cursor: pointer;" 
           onclick="openSystemDetail(event, '{{ system.id }}', '{{ system.name }}', '{{ system.number }}', '{{ system.system_type }}', '{% if system.project %}{{ system.project.name }}{% endif %}')">
        <div class="card-body p-4">
          <div class="d-flex justify-content-between align-items-start mb-3">
            <div class="system-icon">
              {% if system.system_type == "1" or system.system_type == "Database" %}
                <i class="fas fa-database fs-2 text-primary"></i>
              {% elif system.system_type == "2" or system.system_type == "VPN" %}
                <i class="fas fa-shield-alt fs-2 text-success"></i>
              {% elif system.system_type == "3" or system.system_type == "SERVER" %}
                <i class="fas fa-server fs-2 text-warning"></i>
              {% elif system.system_type == "4" or system.system_type == "Application" %}
                <i class="fas fa-desktop fs-2 text-info"></i>
              {% else %}
                <i class="fas fa-cog fs-2 text-secondary"></i>
              {% endif %}
            </div>
            <div class="d-flex align-items-center gap-2">
              {% if system.shares.exists %}
                {% for share in system.shares.all %}
                  {% if share.is_public %}
                    <span class="badge bg-success bg-opacity-10 text-success px-2 py-1 rounded-pill" title="Herkese Açık">
                      <i class="fas fa-globe me-1"></i>Herkese Açık
                    </span>
                  {% else %}
                    <span class="badge bg-primary bg-opacity-10 text-primary px-2 py-1 rounded-pill" title="Paylaşılmış">
                      <i class="fas fa-share-alt me-1"></i>Paylaşılmış
                    </span>
                  {% endif %}
                {% endfor %}
              {% endif %}
              <div class="dropdown" onclick="event.stopPropagation();">
                <button class="btn btn-light btn-sm rounded-circle" type="button" data-bs-toggle="dropdown">
                  <i class="fas fa-ellipsis-v"></i>
                </button>
                <ul class="dropdown-menu dropdown-menu-end">
                  <li>
                    <a class="dropdown-item" href="#" 
                       data-bs-toggle="modal" 
                       data-bs-target="#sistemDuzenleModal"
                       data-id="{{ system.id }}"
                       data-name="{{ system.name }}"
                       data-number="{{ system.number }}"
                       data-system-type="{{ system.system_type }}"
                       data-project-id="{% if system.project %}{{ system.project.id }}{% endif %}">
                      <i class="fas fa-edit me-2"></i>Düzenle
                    </a>
                  </li>
                  <li>
                    <a class="dropdown-item text-danger" href="#"
                       data-bs-toggle="modal"
                       data-bs-target="#sistemSilModal"
                       data-id="{{ system.id }}"
                       data-name="{{ system.name }}">
                      <i class="fas fa-trash me-2"></i>Sil
                    </a>
                  </li>
                </ul>
              </div>
            </div>
          </div>
          
          <h5 class="card-title fw-bold mb-2">{{ system.name }}</h5>
          {% if system.project %}
          <p class="text-muted mb-2">
            <i class="fas fa-folder me-1"></i>{{ system.project.name }}
          </p>
          {% endif %}
          <p class="text-muted mb-2">
            <i class="fas fa-hashtag me-1"></i>{{ system.number }}
          </p>
          
          <div class="system-type-badge mb-3">
            {% if system.system_type == "1" or system.system_type == "Database" %}
              <span class="badge bg-primary bg-opacity-10 text-primary px-3 py-2 rounded-pill">
                <i class="fas fa-database me-1"></i>Database
              </span>
            {% elif system.system_type == "2" or system.system_type == "VPN" %}
              <span class="badge bg-success bg-opacity-10 text-success px-3 py-2 rounded-pill">
                <i class="fas fa-shield-alt me-1"></i>VPN
              </span>
            {% elif system.system_type == "3" or system.system_type == "SERVER" %}
              <span class="badge bg-warning bg-opacity-10 text-warning px-3 py-2 rounded-pill">
                <i class="fas fa-server me-1"></i>Server
              </span>
            {% elif system.system_type == "4" or system.system_type == "Application" %}
              <span class="badge bg-info bg-opacity-10 text-info px-3 py-2 rounded-pill">
                <i class="fas fa-desktop me-1"></i>Application
              </span>
            {% else %}
              <span class="badge bg-secondary bg-opacity-10 text-secondary px-3 py-2 rounded-pill">
                <i class="fas fa-cog me-1"></i>{{ system.system_type }}
              </span>
            {% endif %}
          </div>
          
          <div class="d-flex justify-content-between align-items-center">
            <small class="text-muted">
              <i class="fas fa-clock me-1"></i>ID: {{ system.id }}
            </small>
            {% if user.can_share_systems %}
            <div class="btn-group" onclick="event.stopPropagation();">
              <button class="btn btn-outline-success btn-sm rounded-pill px-3"
                      onclick="sistemPaylas('{{ system.id }}', '{{ system.name }}')"
                      title="Sistemi Paylaş"
                      type="button">
                <i class="fas fa-share-alt"></i>
              </button>
            </div>
            {% endif %}
          </div>
        </div>
      </div>
    </div>
    {% empty %}
    <div class="col-12">
      <div class="text-center py-5">
        <i class="fas fa-cogs fs-1 text-muted mb-3"></i>
        <h4 class="text-muted">Henüz sistem eklenmemiş</h4>
        <p class="text-muted mb-4">İlk sisteminizi eklemek için "Yeni Sistem" butonuna tıklayın.</p>
        <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#sistemEkleModal">
          <i class="fas fa-plus-circle me-2"></i>Yeni Sistem Ekle
        </button>
      </div>
    </div>
    {% endfor %}
  </div>
</div>

<!-- Sistem Ekle Modal -->
<div class="modal fade" id="sistemEkleModal" tabindex="-1" aria-labelledby="sistemEkleModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header border-0 bg-primary bg-opacity-10">
        <h5 class="modal-title fw-bold text-primary" id="sistemEkleModalLabel">
          <i class="fas fa-plus-circle me-2"></i>Yeni Sistem Ekle
        </h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <form>
          <div class="row g-3">
            <div class="col-md-6">
              <label for="projeAdi" class="form-label fw-medium">Proje Adı</label>
              <select class="form-select" id="projeAdi">
                <option value="">Proje seçiniz</option>
                {% for project in projects %}
                <option value="{{ project.id }}">{{ project.name }}</option>
                {% endfor %}
              </select>
            </div>
            <div class="col-md-6">
              <label for="sistemTipi" class="form-label fw-medium">Sistem Tipi</label>
              <select class="form-select" id="sistemTipi" onchange="sistemTipiDegisti()">
                <option value="">Seçiniz</option>
                <option value="1">Database</option>
                <option value="2">VPN</option>
                <option value="3">SERVER</option>
                <option value="4">Application</option>
              </select>
            </div>
            <div class="col-md-6">
              <label for="sistemAdi" class="form-label fw-medium">Sistem Adı</label>
              <input type="text" class="form-control" id="sistemAdi" placeholder="Sistem adını giriniz">
            </div>
            <div class="col-md-6">
              <label for="sistemNo" class="form-label fw-medium">Sistem No</label>
              <input type="text" class="form-control" id="sistemNo" placeholder="Sistem numarasını giriniz">
            </div>
          </div>
          
          <!-- VPN Alanları -->
          <div id="vpnAlanlari" class="row g-3 mt-3" style="display: none;">
            <div class="col-12">
              <h6 class="text-primary fw-bold mb-3">
                <i class="fas fa-shield-alt me-2"></i>VPN Bilgileri
              </h6>
            </div>
            <div class="col-md-6">
              <label for="vpnServer" class="form-label fw-medium">VPN Server</label>
              <input type="text" class="form-control" id="vpnServer" placeholder="VPN server adresini giriniz">
            </div>
            <div class="col-md-6">
              <label for="vpnKullaniciAdi" class="form-label fw-medium">Kullanıcı Adı</label>
              <input type="text" class="form-control" id="vpnKullaniciAdi" placeholder="VPN kullanıcı adını giriniz">
            </div>
            <div class="col-md-6">
              <label for="vpnSifre" class="form-label fw-medium">Şifre</label>
              <div class="input-group">
                <input type="password" class="form-control" id="vpnSifre" placeholder="VPN şifresini giriniz">
                <button class="btn btn-outline-secondary" type="button" onclick="togglePassword('vpnSifre')">
                  <i class="fas fa-eye"></i>
                </button>
              </div>
            </div>
            <div class="col-md-6">
              <label for="vpnPort" class="form-label fw-medium">Port</label>
              <input type="text" class="form-control" id="vpnPort" placeholder="VPN port numarasını giriniz">
            </div>
          </div>
          
          <!-- Database Alanları -->
          <div id="databaseAlanlari" class="row g-3 mt-3" style="display: none;">
            <div class="col-12">
              <h6 class="text-primary fw-bold mb-3">
                <i class="fas fa-database me-2"></i>Database Bilgileri
              </h6>
            </div>
            <div class="col-md-6">
              <label for="dbHost" class="form-label fw-medium">Host</label>
              <input type="text" class="form-control" id="dbHost" placeholder="Database host adresini giriniz">
            </div>
            <div class="col-md-6">
              <label for="dbPort" class="form-label fw-medium">Port</label>
              <input type="text" class="form-control" id="dbPort" placeholder="Database port numarasını giriniz">
            </div>
            <div class="col-md-6">
              <label for="dbKullaniciAdi" class="form-label fw-medium">Kullanıcı Adı</label>
              <input type="text" class="form-control" id="dbKullaniciAdi" placeholder="Database kullanıcı adını giriniz">
            </div>
            <div class="col-md-6">
              <label for="dbSifre" class="form-label fw-medium">Şifre</label>
              <div class="input-group">
                <input type="password" class="form-control" id="dbSifre" placeholder="Database şifresini giriniz">
                <button class="btn btn-outline-secondary" type="button" onclick="togglePassword('dbSifre')">
                  <i class="fas fa-eye"></i>
                </button>
              </div>
            </div>
          </div>
          
          <!-- Server Alanları -->
          <div id="serverAlanlari" class="row g-3 mt-3" style="display: none;">
            <div class="col-12">
              <h6 class="text-warning fw-bold mb-3">
                <i class="fas fa-server me-2"></i>Server Bilgileri
              </h6>
            </div>
            <div class="col-md-6">
              <label for="serverIP" class="form-label fw-medium">IP Adresi</label>
              <input type="text" class="form-control" id="serverIP" placeholder="Server IP adresini giriniz">
            </div>
            <div class="col-md-6">
              <label for="serverOS" class="form-label fw-medium">İşletim Sistemi</label>
              <input type="text" class="form-control" id="serverOS" placeholder="İşletim sistemini giriniz">
            </div>
            <div class="col-md-6">
              <label for="serverKullaniciAdi" class="form-label fw-medium">Kullanıcı Adı</label>
              <input type="text" class="form-control" id="serverKullaniciAdi" placeholder="Server kullanıcı adını giriniz">
            </div>
            <div class="col-md-6">
              <label for="serverSifre" class="form-label fw-medium">Şifre</label>
              <div class="input-group">
                <input type="password" class="form-control" id="serverSifre" placeholder="Server şifresini giriniz">
                <button class="btn btn-outline-secondary" type="button" onclick="togglePassword('serverSifre')">
                  <i class="fas fa-eye"></i>
                </button>
              </div>
            </div>
          </div>
          
          <!-- Application Alanları -->
          <div id="applicationAlanlari" class="row g-3 mt-3" style="display: none;">
            <div class="col-12">
              <h6 class="text-info fw-bold mb-3">
                <i class="fas fa-desktop me-2"></i>Uygulama Bilgileri
              </h6>
            </div>
            <div class="col-md-6">
              <label for="appURL" class="form-label fw-medium">URL</label>
              <input type="text" class="form-control" id="appURL" placeholder="Uygulama URL'sini giriniz">
            </div>
            <div class="col-md-6">
              <label for="appVersiyon" class="form-label fw-medium">Versiyon</label>
              <input type="text" class="form-control" id="appVersiyon" placeholder="Uygulama versiyonunu giriniz">
            </div>
            <div class="col-md-6">
              <label for="appKullaniciAdi" class="form-label fw-medium">Kullanıcı Adı</label>
              <input type="text" class="form-control" id="appKullaniciAdi" placeholder="Uygulama kullanıcı adını giriniz">
            </div>
            <div class="col-md-6">
              <label for="appSifre" class="form-label fw-medium">Şifre</label>
              <div class="input-group">
                <input type="password" class="form-control" id="appSifre" placeholder="Uygulama şifresini giriniz">
                <button class="btn btn-outline-secondary" type="button" onclick="togglePassword('appSifre')">
                  <i class="fas fa-eye"></i>
                </button>
              </div>
            </div>
          </div>
        </form>
      </div>
      <div class="modal-footer border-0">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">İptal</button>
        <button type="button" class="btn btn-primary" onclick="sistemEkle()">
          <i class="fas fa-save me-2"></i>Kaydet
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Sistem Düzenle Modal -->
<div class="modal fade" id="sistemDuzenleModal" tabindex="-1" aria-labelledby="sistemDuzenleModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header border-0 bg-primary bg-opacity-10">
        <h5 class="modal-title fw-bold text-primary" id="sistemDuzenleModalLabel">
          <i class="fas fa-edit me-2"></i>Sistem Düzenle
        </h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <form id="duzenleForm">
          <input type="hidden" id="duzenle_sistemId">
          <div class="row g-3">
            <div class="col-md-6">
              <label for="duzenle_projeAdi" class="form-label fw-medium">Proje Adı</label>
              <select class="form-select" id="duzenle_projeAdi">
                <option value="">Proje seçiniz</option>
                {% for project in projects %}
                <option value="{{ project.id }}">{{ project.name }}</option>
                {% endfor %}
              </select>
            </div>
            <div class="col-md-6">
              <label for="duzenle_sistemTipi" class="form-label fw-medium">Sistem Tipi</label>
              <select class="form-select" id="duzenle_sistemTipi" onchange="duzenle_sistemTipiDegisti()">
                <option value="0">Seçiniz</option>
                <option value="1">Database</option>
                <option value="2">VPN</option>
                <option value="3">SERVER</option>
                <option value="4">Application</option>
              </select>
            </div>
            <div class="col-md-6">
              <label for="duzenle_sistemAdi" class="form-label fw-medium">Sistem Adı</label>
              <input type="text" class="form-control" id="duzenle_sistemAdi" placeholder="Sistem adını giriniz">
            </div>
            <div class="col-md-6">
              <label for="duzenle_sistemNo" class="form-label fw-medium">Sistem No</label>
              <input type="text" class="form-control" id="duzenle_sistemNo" placeholder="Sistem numarasını giriniz">
            </div>
          </div>
          
          <!-- VPN Alanları -->
          <div id="duzenle_vpnAlanlari" class="row g-3 mt-3" style="display: none;">
            <div class="col-12">
              <h6 class="text-primary fw-bold mb-3">
                <i class="fas fa-shield-alt me-2"></i>VPN Bilgileri
              </h6>
            </div>
            <div class="col-md-6">
              <label for="duzenle_vpnServer" class="form-label fw-medium">VPN Server</label>
              <input type="text" class="form-control" id="duzenle_vpnServer" placeholder="VPN server adresini giriniz">
            </div>
            <div class="col-md-6">
              <label for="duzenle_vpnKullaniciAdi" class="form-label fw-medium">Kullanıcı Adı</label>
              <input type="text" class="form-control" id="duzenle_vpnKullaniciAdi" placeholder="VPN kullanıcı adını giriniz">
            </div>
            <div class="col-md-6">
              <label for="duzenle_vpnSifre" class="form-label fw-medium">Şifre</label>
              <div class="input-group">
                <input type="password" class="form-control" id="duzenle_vpnSifre" placeholder="VPN şifresini giriniz">
                <button class="btn btn-outline-secondary" type="button" onclick="togglePassword('duzenle_vpnSifre')">
                  <i class="fas fa-eye"></i>
                </button>
              </div>
            </div>
            <div class="col-md-6">
              <label for="duzenle_vpnPort" class="form-label fw-medium">Port</label>
              <input type="text" class="form-control" id="duzenle_vpnPort" placeholder="VPN port numarasını giriniz">
            </div>
          </div>
          
          <!-- Database Alanları -->
          <div id="duzenle_databaseAlanlari" class="row g-3 mt-3" style="display: none;">
            <div class="col-12">
              <h6 class="text-primary fw-bold mb-3">
                <i class="fas fa-database me-2"></i>Database Bilgileri
              </h6>
            </div>
            <div class="col-md-6">
              <label for="duzenle_dbHost" class="form-label fw-medium">Host</label>
              <input type="text" class="form-control" id="duzenle_dbHost" placeholder="Database host adresini giriniz">
            </div>
            <div class="col-md-6">
              <label for="duzenle_dbPort" class="form-label fw-medium">Port</label>
              <input type="text" class="form-control" id="duzenle_dbPort" placeholder="Database port numarasını giriniz">
            </div>
            <div class="col-md-6">
              <label for="duzenle_dbKullaniciAdi" class="form-label fw-medium">Kullanıcı Adı</label>
              <input type="text" class="form-control" id="duzenle_dbKullaniciAdi" placeholder="Database kullanıcı adını giriniz">
            </div>
            <div class="col-md-6">
              <label for="duzenle_dbSifre" class="form-label fw-medium">Şifre</label>
              <div class="input-group">
                <input type="password" class="form-control" id="duzenle_dbSifre" placeholder="Database şifresini giriniz">
                <button class="btn btn-outline-secondary" type="button" onclick="togglePassword('duzenle_dbSifre')">
                  <i class="fas fa-eye"></i>
                </button>
              </div>
            </div>
          </div>
          
          <!-- Server Alanları -->
          <div id="duzenle_serverAlanlari" class="row g-3 mt-3" style="display: none;">
            <div class="col-12">
              <h6 class="text-warning fw-bold mb-3">
                <i class="fas fa-server me-2"></i>Server Bilgileri
              </h6>
            </div>
            <div class="col-md-6">
              <label for="duzenle_serverIP" class="form-label fw-medium">IP Adresi</label>
              <input type="text" class="form-control" id="duzenle_serverIP" placeholder="Server IP adresini giriniz">
            </div>
            <div class="col-md-6">
              <label for="duzenle_serverOS" class="form-label fw-medium">İşletim Sistemi</label>
              <input type="text" class="form-control" id="duzenle_serverOS" placeholder="İşletim sistemini giriniz">
            </div>
            <div class="col-md-6">
              <label for="duzenle_serverKullaniciAdi" class="form-label fw-medium">Kullanıcı Adı</label>
              <input type="text" class="form-control" id="duzenle_serverKullaniciAdi" placeholder="Server kullanıcı adını giriniz">
            </div>
            <div class="col-md-6">
              <label for="duzenle_serverSifre" class="form-label fw-medium">Şifre</label>
              <div class="input-group">
                <input type="password" class="form-control" id="duzenle_serverSifre" placeholder="Server şifresini giriniz">
                <button class="btn btn-outline-secondary" type="button" onclick="togglePassword('duzenle_serverSifre')">
                  <i class="fas fa-eye"></i>
                </button>
              </div>
            </div>
          </div>
          
          <!-- Application Alanları -->
          <div id="duzenle_applicationAlanlari" class="row g-3 mt-3" style="display: none;">
            <div class="col-12">
              <h6 class="text-info fw-bold mb-3">
                <i class="fas fa-desktop me-2"></i>Uygulama Bilgileri
              </h6>
            </div>
            <div class="col-md-6">
              <label for="duzenle_appURL" class="form-label fw-medium">URL</label>
              <input type="text" class="form-control" id="duzenle_appURL" placeholder="Uygulama URL'sini giriniz">
            </div>
            <div class="col-md-6">
              <label for="duzenle_appVersiyon" class="form-label fw-medium">Versiyon</label>
              <input type="text" class="form-control" id="duzenle_appVersiyon" placeholder="Uygulama versiyonunu giriniz">
            </div>
            <div class="col-md-6">
              <label for="duzenle_appKullaniciAdi" class="form-label fw-medium">Kullanıcı Adı</label>
              <input type="text" class="form-control" id="duzenle_appKullaniciAdi" placeholder="Uygulama kullanıcı adını giriniz">
            </div>
            <div class="col-md-6">
              <label for="duzenle_appSifre" class="form-label fw-medium">Şifre</label>
              <div class="input-group">
                <input type="password" class="form-control" id="duzenle_appSifre" placeholder="Uygulama şifresini giriniz">
                <button class="btn btn-outline-secondary" type="button" onclick="togglePassword('duzenle_appSifre')">
                  <i class="fas fa-eye"></i>
                </button>
              </div>
            </div>
          </div>
        </form>
      </div>
      <div class="modal-footer border-0">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">İptal</button>
        <button type="button" class="btn btn-primary" onclick="sistemGuncelle()">
          <i class="fas fa-save me-2"></i>Güncelle
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Sistem Detay Modal -->
<div class="modal fade" id="sistemDetayModal" tabindex="-1" aria-labelledby="sistemDetayModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header border-0 bg-info bg-opacity-10">
        <h5 class="modal-title fw-bold text-info" id="sistemDetayModalLabel">
          <i class="fas fa-info-circle me-2"></i>Sistem Detayları
        </h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <div class="row g-4">
          <!-- Temel Bilgiler -->
          <div class="col-12">
            <div class="card border-0 bg-light">
              <div class="card-body">
                <h6 class="card-title fw-bold text-primary mb-3">
                  <i class="fas fa-info-circle me-2"></i>Temel Bilgiler
                </h6>
                <div class="row g-3">
                  <div class="col-md-6">
                    <label class="form-label fw-medium text-muted">Sistem Adı</label>
                    <button class="btn btn-outline-primary btn-sm ms-2" onclick="copyToClipboard('detay_sistemAdi')" title="Kopyala">
                      <i class="fas fa-copy"></i>
                    </button>
                    <div class="bg-white p-3 rounded border d-flex justify-content-between align-items-center">
                      <p class="mb-0 fw-bold" id="detay_sistemAdi">-</p>
                    </div>
                  </div>
                  <div class="col-md-6">
                    <label class="form-label fw-medium text-muted">Sistem No</label>
                    <button class="btn btn-outline-primary btn-sm ms-2" onclick="copyToClipboard('detay_sistemNo')" title="Kopyala">
                      <i class="fas fa-copy"></i>
                    </button>
                    <div class="bg-white p-3 rounded border d-flex justify-content-between align-items-center">
                      <p class="mb-0 fw-bold" id="detay_sistemNo">-</p>
                    </div>
                  </div>
                  <div class="col-md-6">
                    <label class="form-label fw-medium text-muted">Proje</label>
                    <button class="btn btn-outline-primary btn-sm ms-2" onclick="copyToClipboard('detay_projeAdi')" title="Kopyala">
                      <i class="fas fa-copy"></i>
                    </button>
                    <div class="bg-white p-3 rounded border d-flex justify-content-between align-items-center">
                      <p class="mb-0 fw-bold" id="detay_projeAdi">-</p>
                    </div>
                  </div>
                  <div class="col-md-6">
                    <label class="form-label fw-medium text-muted">Sistem Tipi</label>
                    <div class="bg-white p-3 rounded border">
                      <p class="mb-0" id="detay_sistemTipi">-</p>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
          
          <!-- Ek Bilgiler -->
          <div class="col-12" id="detay_ekBilgiler" style="display: none;">
            <div class="card border-0 bg-light">
              <div class="card-body">
                <h6 class="card-title fw-bold text-success mb-3">
                  <i class="fas fa-cogs me-2"></i>Ek Bilgiler
                </h6>
                <div class="row g-3" id="detay_ekBilgilerIcerik">
                  <!-- Dinamik olarak doldurulacak -->
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
      <div class="modal-footer border-0">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Kapat</button>
      </div>
    </div>
  </div>
</div>

<!-- Sistem Sil Modal -->
<div class="modal fade" id="sistemSilModal" tabindex="-1" aria-labelledby="sistemSilModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header border-0 bg-danger bg-opacity-10">
        <h5 class="modal-title fw-bold text-danger" id="sistemSilModalLabel">
          <i class="fas fa-exclamation-triangle me-2"></i>Sistem Sil
        </h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <input type="hidden" id="sil_sistemId">
        <p class="mb-3">Aşağıdaki sistemi silmek istediğinizden emin misiniz?</p>
        <div class="alert alert-light border">
          <h6 class="mb-1 fw-bold" id="sil_sistemAdi"></h6>
          <small class="text-muted">Bu işlem geri alınamaz!</small>
        </div>
      </div>
      <div class="modal-footer border-0">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Vazgeç</button>
        <button type="button" class="btn btn-danger" onclick="sistemSil()">
          <i class="fas fa-trash me-2"></i>Sil
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Sistem Paylaş Modal -->
{% if user.can_share_systems %}
<div class="modal fade" id="sistemPaylasModal" tabindex="-1" aria-labelledby="sistemPaylasModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content border-0 shadow-lg">
      <!-- Modal Header -->
      <div class="modal-header border-0 position-relative overflow-hidden" style="background: linear-gradient(45deg, #4158D0, #C850C0, #FFCC70);">
        <div class="position-absolute w-100 h-100" style="background: rgba(255,255,255,0.1); backdrop-filter: blur(5px);"></div>
        <div class="d-flex align-items-center position-relative">
          <div class="bg-white bg-opacity-20 rounded-circle p-3 me-3 shadow-sm">
            <i class="fas fa-share-alt text-white fs-4"></i>
          </div>
          <div>
            <h5 class="modal-title text-white fw-bold mb-1" id="sistemPaylasModalLabel">
              Sistem Paylaşımı
            </h5>
            <p class="text-white-50 mb-0 small" style="text-shadow: 0 1px 2px rgba(0,0,0,0.1);">
              <i class="fas fa-info-circle me-1"></i>
              Sistemi diğer kullanıcılarla paylaşın ve erişim ayarlarını yönetin
            </p>
          </div>
        </div>
        <button type="button" class="btn-close btn-close-white position-relative" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>

      <!-- Modal Body -->
      <div class="modal-body p-4">
        <input type="hidden" id="paylas_sistemId">
        
        <!-- Erişim Tipi Seçimi -->
        <div class="mb-4">
          <label class="form-label fw-medium text-primary mb-3">
            <i class="fas fa-lock me-2"></i>Erişim Ayarları
          </label>
          <div class="row g-3">
            <div class="col-6">
              <div class="card h-100 border-0 shadow-sm cursor-pointer" 
                   onclick="document.getElementById('erisimHerkes').click()"
                   style="cursor: pointer; transition: all 0.3s ease;">
                <div class="card-body p-3">
                  <div class="form-check mb-0">
                    <input class="form-check-input" type="radio" name="erisimTipi" id="erisimHerkes" value="herkes" checked>
                    <label class="form-check-label w-100" for="erisimHerkes">
                      <div class="d-flex align-items-center">
                        <div class="bg-primary bg-opacity-10 rounded-3 p-2 me-3">
                          <i class="fas fa-globe text-primary"></i>
                        </div>
                        <div>
                          <h6 class="mb-1 fw-bold">Herkese Açık</h6>
                          <p class="text-muted small mb-0">Tüm kullanıcılar erişebilir</p>
                        </div>
                      </div>
                    </label>
                  </div>
                </div>
              </div>
            </div>
            <div class="col-6">
              <div class="card h-100 border-0 shadow-sm cursor-pointer"
                   onclick="document.getElementById('erisimOzel').click()"
                   style="cursor: pointer; transition: all 0.3s ease;">
                <div class="card-body p-3">
                  <div class="form-check mb-0">
                    <input class="form-check-input" type="radio" name="erisimTipi" id="erisimOzel" value="ozel">
                    <label class="form-check-label w-100" for="erisimOzel">
                      <div class="d-flex align-items-center">
                        <div class="bg-success bg-opacity-10 rounded-3 p-2 me-3">
                          <i class="fas fa-user-friends text-success"></i>
                        </div>
                        <div>
                          <h6 class="mb-1 fw-bold">Özel Erişim</h6>
                          <p class="text-muted small mb-0">Sadece seçili kullanıcılar</p>
                        </div>
                      </div>
                    </label>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Özel Erişim Ayarları -->
        <div id="ozelErisimAyarlari" class="mb-4" style="display: none;">
          <div class="card border-0 shadow-sm">
            <div class="card-body p-3">
              <label class="form-label fw-medium text-primary mb-3">
                <i class="fas fa-users me-2"></i>Kullanıcı Seçimi
              </label>
              <div class="input-group mb-3">
                <span class="input-group-text bg-light border-0">
                  <i class="fas fa-search text-muted"></i>
                </span>
                <input type="text" class="form-control border-0 bg-light" 
                       id="userSearch" placeholder="Kullanıcı ara..."
                       onkeyup="filterUsers()">
              </div>
              <div class="user-list" style="max-height: 200px; overflow-y: auto;">
                <select class="form-select border-0 bg-light" id="ozelKullanicilar" multiple size="5">
                  <!-- Kullanıcılar dinamik olarak eklenecek -->
                </select>
              </div>
              <small class="text-muted mt-2 d-block">
                <i class="fas fa-info-circle me-1"></i>
                Birden fazla kullanıcı seçmek için CTRL tuşuna basılı tutun
              </small>
            </div>
          </div>
        </div>

        <!-- Paylaşım Bilgileri -->
        <div class="alert alert-light border-0 shadow-sm mb-0">
          <div class="d-flex">
            <div class="flex-shrink-0">
              <i class="fas fa-info-circle text-primary"></i>
            </div>
            <div class="flex-grow-1 ms-3">
              <h6 class="alert-heading mb-1">Paylaşım Bilgileri</h6>
              <p class="mb-0 small text-muted">
                Paylaşılan sistemler, seçilen erişim tipine göre diğer kullanıcılar tarafından görüntülenebilir.
                Paylaşım ayarlarını istediğiniz zaman güncelleyebilirsiniz.
              </p>
            </div>
          </div>
        </div>
      </div>

      <!-- Modal Footer -->
      <div class="modal-footer border-0 bg-light">
        <button type="button" class="btn btn-light px-4" data-bs-dismiss="modal">
          <i class="fas fa-times me-2"></i>Vazgeç
        </button>
        <button type="button" class="btn btn-primary px-4" onclick="paylasimiKaydet()">
          <i class="fas fa-share-alt me-2"></i>Paylaşımı Oluştur
        </button>
      </div>
    </div>
  </div>
</div>
{% endif %}
{% endblock %}

{% block extra_js %}
<script src="{% static 'keychain/js/sistem_list.js' %}"></script>
<script>
// Proje filtreleme fonksiyonu - currentProjectFilter zaten sistem_list.js'de tanımlı

function filterByProject(projectName) {
  console.log('=== filterByProject çağrıldı ===');
  console.log('Gelen projectName:', projectName);
  console.log('Önceki currentProjectFilter:', currentProjectFilter);
  
  currentProjectFilter = projectName;
  console.log('Yeni currentProjectFilter:', currentProjectFilter);
  
  // Dropdown butonunun metnini güncelle - daha spesifik seçici kullan
  const dropdownButton = document.querySelector('.dropdown[aria-label="Projeler"] button');
  console.log('Dropdown button bulundu:', dropdownButton);
  
  if (projectName === 'all') {
    dropdownButton.innerHTML = `<i class="fas fa-folder me-2"></i>Projeler`;
    console.log('Tüm projeler seçildi, buton metni güncellendi');
  } else {
    const dropdownItems = document.querySelectorAll('.dropdown[aria-label="Projeler"] .dropdown-menu .dropdown-item');
    console.log('Dropdown items bulundu:', dropdownItems.length);
    
    dropdownItems.forEach((item, index) => {
      const onclickAttr = item.getAttribute('onclick');
      console.log(`Item ${index}:`, item.textContent.trim(), 'onclick:', onclickAttr);
      
      if (onclickAttr && onclickAttr.includes(projectName)) {
        const text = item.textContent.trim();
        dropdownButton.innerHTML = `<i class="fas fa-folder me-2"></i>${text}`;
        console.log('Buton metni güncellendi:', text);
      }
    });
  }
  
  console.log('filterSystems çağrılıyor...');
  // Sistemleri filtrele
  filterSystems();
  console.log('=== filterByProject tamamlandı ===');
}

// Sistemleri filtreleme fonksiyonu
function filterSystems() {
  const searchText = document.getElementById('systemSearch').value.toLowerCase();
  const activeFilterElement = document.querySelector('[data-filter].active');
  const activeFilter = activeFilterElement ? activeFilterElement.getAttribute('data-filter') : 'all';
  const systemCards = document.querySelectorAll('.system-card');
  const searchContainer = document.querySelector('.search-container');

  // Debug için console.log ekleyelim
  console.log('=== filterSystems başlatıldı ===');
  console.log('Arama metni:', searchText);
  console.log('Aktif sistem filtresi:', activeFilter);
  console.log('Aktif proje filtresi:', currentProjectFilter);
  console.log('Toplam sistem kartı sayısı:', systemCards.length);

  // Add loading animation
  if (searchContainer) {
    searchContainer.classList.add('searching');
    setTimeout(() => {
      searchContainer.classList.remove('searching');
    }, 300);
  }

  systemCards.forEach((card, index) => {
    const systemType = card.querySelector('.system-type-badge').textContent.trim().toLowerCase();
    const systemName = card.querySelector('.card-title').textContent.toLowerCase();
    const systemNumber = card.querySelector('.text-muted:nth-of-type(2)').textContent.toLowerCase();
    
    // Proje adını data attribute'dan al
    const projectName = card.getAttribute('data-project-name') || '';
    const actualProjectName = projectName === 'none' ? '' : projectName;
    
    const projectId = card.getAttribute('data-project-id');

    const matchesFilter = activeFilter === 'all' || systemType.includes(activeFilter.toLowerCase());
    const matchesSearch = systemName.includes(searchText) || 
                        systemNumber.includes(searchText) || 
                        actualProjectName.toLowerCase().includes(searchText);
    const matchesProject = currentProjectFilter === 'all' || actualProjectName.toLowerCase().includes(currentProjectFilter.toLowerCase());

    // Debug için her kartın durumunu logla
    console.log(`Kart ${index}: Sistem: ${systemName}, Proje Adı: ${actualProjectName}, Seçilen Proje: ${currentProjectFilter}, Filtre: ${matchesFilter}, Arama: ${matchesSearch}, Proje: ${matchesProject}`);

    if (matchesFilter && matchesSearch && matchesProject) {
      card.closest('.col-xl-3').style.display = '';
      card.closest('.col-xl-3').classList.add('fade-in');
    } else {
      card.closest('.col-xl-3').style.display = 'none';
      card.closest('.col-xl-3').classList.remove('fade-in');
    }
  });
  
  console.log('=== filterSystems tamamlandı ===');
}
</script>
{% endblock %}
